<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Geocoding</title>
  </head>
  <body>
    <pre id="log" style="user-select: none">Loading</pre>
    <pre id="output" style="user-select: all">…</pre>

    <script>
      const log = document.querySelector("#log");
      const output = document.querySelector("#output");
      const sleep = 2000;

      const routes = [
        "Sanxenxo, Spain; Pamplona, Spain",
        "Huelva, Spain; Pamplona, Spain",
        "Zaragoza, Spain; Pamplona, Spain",
        "Madrid, Spain; Lausanne, Switzerland; Pamplona, Spain",
        "Reconquista, Argentina; Buenos Aires, Argentina",
        "Murcia, Spain; San Sebastián, Spain",
        "Pamplona, Spain",
        "Madrid, Spain; Dublin, Ireland; Pamplona, Spain",
        "Lyon, France; Marseille, France; Barcelona, Spain; Aguascalientes, México; Pamplona, Spain",
        "Coxen Hole, Honduras; Miramar, US",
        "Caracas, Venezuela; Santo Domingo, Dominican Republic",
        "Pamplona, Spain; Bayonne, France; Stirling, Scotland",
        "Mexico City, Mexico; Bogota, Colombia; Hong Kong; Pamplona, Spain",
        "Pamplona, Spain; Biarritz, France; Budapest, Hungary; London, England",
        "Caracas, Venezuela; Ciudad de Panamá, Panamá; Funchal, Madeira",
        "Las Palmas de Gran Canaria, Spain",
        "Geneva, Switzerland; Ourense, Spain; Pamplona, Spain; San José, Costa Rica ",
        "Lima, Peru; Pamplona, Spain; Madrid, Spain",
        "Zaragoza, Spain; Pamplona, Spain; Sydney, Australia",
        "Manizales, Colombia; Bogotá, Colombia; Columbus, United States; Mechelen, Belgium; Pamplona, Spain",
        "Benidorm, Spain",
        "Zaragoza, Spain",
        "Sevilla, Spain",
        "Valencia, Spain",
        "León, Spain; Pamplona, Spain",
        "Raleigh, US; Miami, US; New York, US",
        "Quito, Ecuador; Richmond, US; Pamplona, Spain",
        "Toluca, Mexico; Pamplona, Spain",
      ];

      let results = [];
      let currentRoute = 0;
      let currentCity = 0;

      async function geocode(routeIndex, cityIndex) {
        const route = routes[routeIndex];
        const cities = route.split(";");
        const city = cities[cityIndex].trim();

        log.textContent = `Geocoding route ${routeIndex}, city ${cityIndex}: ${city}`;

        // Create empty array
        if (cityIndex === 0) {
          results[routeIndex] = [];
        }

        // Try to get coordinates
        const api = `https://nominatim.openstreetmap.org/search?q=${city}&format=jsonv2&limit=1`;

        try {
          const response = await fetch(api);
          const data = await response.json();
          const place = data[0];

          const { lon, lat } = place;

          let coordinates = [parseFloat(lon), parseFloat(lat)];

          results[routeIndex].push(coordinates);

          output.textContent = "";
          for (let item of results) {
            output.textContent += JSON.stringify(item) + "\n";
          }
        } catch {
          console.log("Trying again");

          setTimeout(() => {
            geocode(currentRoute, currentCity);
          }, sleep);
          return;
        }

        // If there is a next city
        if (cities[cityIndex + 1]) {
          currentCity = cityIndex + 1;
          setTimeout(() => {
            geocode(currentRoute, currentCity);
          }, sleep);
        }
        // If there is a next route
        else if (routes[routeIndex + 1]) {
          currentRoute = routeIndex + 1;
          currentCity = 0;
          setTimeout(() => {
            geocode(currentRoute, currentCity);
          }, 500);
        }
        // Otherwise
        else {
          log.textContent = "Done Geocoding";
        }
      }

      geocode(currentRoute, currentCity);
    </script>
  </body>
</html>
